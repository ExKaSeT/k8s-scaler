<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <title>Информация о группе</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/jquery-3.5.1.min.js"></script>
</head>
<body>
<div class="header" th:replace="~{fragments/header :: header}"></div>

<div class="container">
    <h1 th:text="${group.name}" class="text-center mb-4">Группа</h1>

    <!-- Кнопки для выполнения масштабирования и зануления -->
    <div class="text-center mt-5">
        <button id="scale-button" class="btn btn-primary">Масштабировать</button>
        <button id="zero-button" class="btn btn-danger">Занулить</button>
    </div>

    <div th:each="cluster : ${group.clusters}">
        <h3>
            <input type="checkbox" class="cluster-checkbox" th:data-cluster="${cluster.url}" checked> <!-- Кнопка для выбора всего кластера -->
            <span th:text="${cluster.url}"></span>
        </h3>
        <ul class="list-group mb-4">
            <li class="list-group-item" th:each="namespace : ${cluster.namespaces}">
                <h5>
                    <input type="checkbox" class="namespace-checkbox" th:data-cluster="${cluster.url}" th:data-namespace="${namespace.name}" checked> <!-- Кнопка для выбора всего namespace -->
                    <span th:text="${namespace.name}"></span>
                </h5>
                <ul>
                    <li th:each="deployment : ${namespace.deployments}">
                        <label>
                            <input type="checkbox" class="deployment-checkbox" th:data-cluster="${cluster.url}" th:data-namespace="${namespace.name}" th:data-deployment="${deployment.name}" th:data-replicas="${deployment.replicas}" checked>
                            <span th:text="${deployment.name} + ' : ' + ${deployment.replicas}"></span>
                        </label>
                    </li>
                </ul>
            </li>
        </ul>
    </div>
</div>

<script>
    // Выбрать или снять выбор всех деплойментов в кластере
    $('.cluster-checkbox').change(function() {
        let cluster = $(this).data('cluster');
        $('input[type=checkbox][data-cluster="' + cluster + '"]').prop('checked', this.checked);
    });

    // Выбрать или снять выбор всех деплойментов в namespace
    $('.namespace-checkbox').change(function() {
        let cluster = $(this).data('cluster');
        let namespace = $(this).data('namespace');
        $('input[type=checkbox][data-cluster="' + cluster + '"][data-namespace="' + namespace + '"]').prop('checked', this.checked);
    });


    // Собрать данные о выбранных деплойментах
    function collectSelectedDeployments(zeroReplicas = false) {
        let clusters = {};

        // Проходим по каждому отмеченному деплойменту
        $('.deployment-checkbox:checked').each(function () {
            let clusterUrl = $(this).data('cluster');
            let namespaceName = $(this).data('namespace');
            let deploymentName = $(this).data('deployment');
            let replicas = zeroReplicas ? 0 : $(this).data('replicas');

            // Проверяем, есть ли уже такой кластер в объекте
            if (!clusters[clusterUrl]) {
                clusters[clusterUrl] = {
                    url: clusterUrl,
                    namespaces: {}
                };
            }

            // Проверяем, есть ли уже такое пространство имен в кластере
            if (!clusters[clusterUrl].namespaces[namespaceName]) {
                clusters[clusterUrl].namespaces[namespaceName] = {
                    name: namespaceName,
                    deployments: []
                };
            }

            // Добавляем деплоймент в соответствующее пространство имен
            clusters[clusterUrl].namespaces[namespaceName].deployments.push({
                name: deploymentName,
                replicas: replicas
            });
        });

        // Преобразуем namespaces и clusters в массивы, как это нужно по структуре классов
        let result = Object.values(clusters).map(cluster => {
            cluster.namespaces = Object.values(cluster.namespaces);
            return cluster;
        });

        return result;
    }

    // Отправка запроса для масштабирования
    $('#scale-button').click(function () {
        let selectedDeployments = collectSelectedDeployments(false); // Собираем данные с текущими репликами
        sendScaleRequest(selectedDeployments);
    });

    // Отправка запроса для зануления
    $('#zero-button').click(function () {
        let selectedDeployments = collectSelectedDeployments(true); // Собираем данные с replicas = 0
        sendScaleRequest(selectedDeployments);
    });

    // Функция отправки POST-запроса с данными о деплойментах
    function sendScaleRequest(deployments) {
        const currentPath = window.location.pathname;

        $.ajax({
            url: currentPath + '/scale',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(deployments),
            success: function(response) {
                // Обработка ответа сервера (SuccessContainerDto)
                if (response.success) {
                    alert('Успешно: ' + response.message);
                } else {
                    alert('Ошибка: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                alert('Ошибка запроса: ' + error);
            }
        });
    }
</script>
</body>
</html>
